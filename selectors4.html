<!doctype html>
<meta charset=utf-8>
<title>CSS4セレクタ (Selectors Level 4) の新機能</title>
<link rel=stylesheet href="lilium.css">
<link rel=license href="http://creativecommons.org/licenses/by-nc/3.0/">
<script>
if (!!document.addEventListener) {
  document.addEventListener('DOMContentLoaded', function () {
    var sec = document.querySelectorAll('body > section[id]');
    var h = document.querySelectorAll('body > section[id] > h2:first-of-type');    
    var toc = '';
    var l = sec.length;
    while (l--) {
      toc = '<li><a href="#' + sec[l].id + '">' + h[l].innerHTML + '</a>' + toc;
    }
    var nav = document.createElement('nav');
    nav.innerHTML = '<h2>目次</h2><ol>' + toc + '</ol>';
    document.body.insertBefore(nav, sec[0]);
  }, false);
}
</script>
<body>

<h1>CSS4セレクタ (Selectors Level 4) の新機能</h1>
<!-- update: 2011-09-12 -->

<p><a href="http://www.w3.org/TR/css3-selectors/">CSS3のセレクタ仕様</a>が勧告されそうですが、CSS4のセレクタについても策定が始まっています。CSS4では誰もが考えた「親セレクタ」をはじめ、より高機能なセレクタが提案されています。このノートでは、CSS4セレクタ仕様で新しく追加された機能について紹介します。

<section id=about-selectors4>
<h2>Selectors Level 4仕様について</h2>

<p><a>Selectors Level 4</a> は、<a href="http://www.w3.org/TR/css3-selectors/">Selectors Level 3</a>仕様の上位にある新しいセレクタ仕様です。Level 3では<code>:nth-child()</code>など便利なセレクタが数多く追加されましたが、Level 4仕様ではより便利なセレクタや、新しい仕組みが検討されています。

<p>2011年9月現在、Selectors Level 4は公式な草案 (Working Draft) が公開されていません。現在は非公式のEditor's Draftのみが公開されています。W3CのCSSWGは、Selectors Level 3勧告と同時にSelectors Level 4の草案を公開する予定です。<!-- ref: http://lists.w3.org/Archives/Public/www-style/2011Aug/0645.html -->

<p>仕様が初期の段階ですから、仕様書にある機能がそのうちなくなる可能性があります。反対に、現在の仕様書にない新しいセレクタが追加される可能性もあります。


<aside id=is-selectors-css>
<h3>「CSS4セレクタ」か「セレクタ Level 4」か</h3>

<p>他のCSS3モジュールはたいてい「CSS <var>Foo</var> Module Level 3」と、CSS3のモジュールだと分かる名前になっていますが、セレクタ仕様については「Selectors Level 3」「Selectors Level 4」と、CSSの名を冠していません。いったいどういうことでしょうか。セレクタ仕様はCSSではないのでしょうか。

<p>これは、他のCSSモジュールと違い、セレクタ仕様は他のWebプラットフォーム仕様で使われることがあるため、CSSに限定されないということを意味しています。たとえば、セレクタから要素を取得する<a href="http://www.w3.org/TR/selectors-api/">Selectors API</a>は、CSSの仕様ではありませんがセレクタを利用しています。セレクタと同様に、<a href="http://www.w3.org/TR/css3-mediaquries">Media Queries</a>もHTMLの<code>media</code>属性などで使われることから、CSSの名を冠していません。

<p>とはいえ、セレクタ仕様やメディアクエリー仕様が「CSSでない」というわけではありません。CSSだけに限定されてはいないだけで、どちらもCSSの機能ではあります。「CSS4セレクタ」という表記は、別におかしくはないのです。

<!-- todo: 参考情報へのURLを探す。 -->
</aside>
</section>

<section id=terminology>
<h2>セレクタの構造と用語</h2>

<p>ふだん「セレクタ」と読んでいるものですが、仕様書に従うとじつはけっこう細かく分けられます。

<dl>
<dt>セレクタ
<dd>単体セレクタ、compound selector、complex selector、セレクタリストを総称
<dt>単体セレクタ
<dd>型セレクタ (要素型セレクタ、type selector)、ユニバーサルセレクタ、属性セレクタ、クラスセレクタ、IDセレクタ、擬似クラス
<dt>compound selector
<dd>結合子をはさまない単体セレクタの連なり
<dt>complex selector
<dd>compound selectorが結合子によって連なったもの
<dt>結合子
<dd>compound selector同士の関係を表すもの、空白、大なり、プラス記号、チルダがあり、俗にそれぞれ「子孫セレクタ」「子セレクタ」「隣接セレクタ」「◯◯セレクタ」などと呼ばれる
</dl>

<p class=XXX>compoundとcomplexってどう訳せばいいんだろう。。

</section>

<section id=subject-and-dollar-sign>
<h2>セレクタの対象と<code>$<var>selector</var></code>記法</h2>

<p>CSS4セレクタでは、念願かなって要素の「親」を指定できるようになりました。<br>ただし、「親セレクタ」が導入されたわけではありません。むしろ、もっと便利な機能の応用例として使えるようになっています。

<p>とりあえず、何かの親にスタイルを当ててみましょう。

<pre><code>ul > <strong>$</strong>li > a { list-style: none }</code></pre>

<p><code>li</code>の前にさりげなく<code><strong>$</strong></code>とあるのがわかるでしょうか。これがCSS4で導入された新機能です。

<p>セレクタによって表される要素 (スタイルが適用される要素) を、セレクタ仕様では「<strong>対象 (subject)</strong>」と呼びます。これまでのレベルでは、各セレクタのうち最後の要素が対象となっていました。

<p>CSS4では、対象としたいcompound selectorの前にドル記号（<code>$</code>）をつけることで、この対象を変更できるようになりました。ですので、<code>ul > <strong>$</strong>li > a</code>とすると、「子に<code>a</code>を持つ<code>li</code>要素」にスタイルを当てられるわけです。

<p class=XXX>todo: もっと例を書く。
<p class=XXX>todo: このわかりにくい説明をなんとかして、もうちょっとキャッチーな文にする。

<aside>
<h3><code>$<var>selector</var></code>はなんと呼ぶか</h3>

<p>なんて呼べばいいんでしょうねえ。とりあえず、combinatorなども「セレクタ」と呼ばれるので、「$セレクタ」（ダラーセレクタ）とか「ドルセレクタ」とかでいい気はしてます。「セレクタ」と呼べないかもしれませんが……

</aside>

</section>

<section id=matches>
<h2>「どれか」にマッチする<code>:matches()</code></h2>

<p>CSS4では、<code>:matches()</code>という擬似クラスが導入されました。引数に複数のセレクタを書くと「そのうちのどれか」にマッチします。

<p>カンマと何が違うんだという話ですが、ネストした場合にとても楽です。HTML5のsectioning content (<code>section</code>, <code>article</code>, <code>aside</code>, <code>nav</code>)と<code>h1</code>の組み合わせを考えてみましょう。

<pre><code>/* トップレベルの見出し */
h1 {
  font-size: 240%;
  font-weight: bold;
}
/* セカンドレベルの見出し */
section h1, article h1, aside h1, nav h1 {
  font-size: 210%;
}
/* サードレベルの見出し */
section section h1, section article h1, section nav h1, section aside h1,
article section h1, article article h1, article nav h1, article aside h1,
aside section h1, aside article h1, aside nav h1, aside aside h1,
nav section h1, nav article h1, nav nav h1, nav aside h1 {
  font-size: 180%;
}
/* もういや…… */</code></pre>

<p>ひどくなります。<code>aside</code>中に<code>article</code>とか、<code>nav</code>中に<code>nav</code>とかどれだけあるんだよと思いもしますが、それはさておいて。ここで<code>:matches()</code>が力を発揮します。

<pre><code>/* トップレベルの見出し */
h1 {
  font-size: 240%;
  font-weight: bold;
}
/* セカンドレベルの見出し */
:matches(section, article, aside, nav) h1 {
  font-size: 210%;
}
/* サードレベルの見出し */
:matches(section, article, aside, nav)
:matches(section, article, aside, nav) h1 {
  font-size: 180%;
}
/* 4th... */
:matches(section, article, aside, nav)
:matches(section, article, aside, nav)
:matches(section, article, aside, nav) h1 {
  font-size: 150%;
}
/* こんな感じで続く！ */</code></pre>

<p>こんな風に、かなり見通しが良くなります。

<p><code>:matches()</code>はもともと、MozillaがGeckoに導入した<code>:-moz-any()</code>という独自拡張のセレクタが元になっています。このセレクタによって、<code>ul</code>, <code>ol</code>, <code>dir</code>などの複雑なネストや、上記のようなHTML5のセクションと見出しのスタイル付けがとても見やすいものになりました。<!-- ref: https://bugzilla.mozilla.org/show_bug.cgi?id=544834 --><!-- ref: http://hg.mozilla.org/mozilla-central/rev/8e552e1afa49 --><!-- ref: http://hg.mozilla.org/mozilla-central/rev/30c9289d5dad#l5.1 -->

<p><code>:-moz-any()</code>はその後WebKitにも<code>:-webkit-any()</code>として導入され、UAスタイルシートでHTML5のセクションと見出しのスタイルづけに利用されています。<!-- ref: http://trac.webkit.org/changeset/81742 --><!-- ref: http://trac.webkit.org/changeset/82400 -->

<p>なお、CSS4では引数内のセレクタにcombinatorが使えないという制限があります。また、<code>:matches()</code>や<code>:not()</code>をネストさせることはできないともされています。

<p class=XXX>todo: もっと実用的な例がないか探す。

</section>

<section id=browser-support>
<h2>ブラウザの対応状況</h2>

<p>Selectors Level 4は初期段階にある仕様ですが、思いのほか実装状況は良好です。

<p>理由のひとつは、仕様書にCSS3のセレクタが含まれてるからです。実装されてるセレクタが最初から多いというわけです。

<p>CSS4で新しく追加されたセレクタについても、ブラウザの独自拡張を標準化したもの (<code>:any-link</code>, <code>:matches()</code>) や、他の仕様から移管されたもの (<code>:valid</code>, <code>:in-range</code>) があります。ですから次のレベルとはいえ、すでに実装が進んでいるとも言えます。

<p class=XXX>新しいセレクタの対応状況を書く。

</section>


<footer>
<address><a rel=author href="http://profiles.google.com/masataka.yakura">Masataka Yakura</a></address>
</footer>

